name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Tag format: v0.1.0 or v0.1.0-alpha.123
          # Strip leading 'v' to get version string
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Cache Homebrew downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew/downloads
            ~/Library/Caches/Homebrew/api
          key: brew-macos-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: brew-macos-

      - name: Install dependencies
        run: brew install qt opus hidapi openssl@3 dbus brotli

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt)" \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -DK4CONTROLLER_VERSION_FULL="${{ steps.version.outputs.version }}"

      - name: Build
        run: cmake --build build --config Release

      - name: Create app bundle with dependencies
        run: |
          set -e

          APP_BUNDLE="build/K4Controller.app"
          FRAMEWORKS="$APP_BUNDLE/Contents/Frameworks"

          # Run macdeployqt to bundle Qt frameworks
          $(brew --prefix qt)/bin/macdeployqt "$APP_BUNDLE" -verbose=2

          # Copy QtDBus.framework (transitive dependency of QtGui in Homebrew Qt)
          # Note: qtbase is the actual package containing Qt libraries, qt@6 is just a meta-formula
          echo "=== Copying QtDBus.framework ==="
          QTBASE_LIB="$(brew --prefix qtbase)/lib"
          echo "QtDBus source: $QTBASE_LIB/QtDBus.framework"
          ls -la "$QTBASE_LIB/QtDBus.framework/Versions/A/" || echo "WARNING: QtDBus not found in qtbase!"
          cp -R "$QTBASE_LIB/QtDBus.framework" "$FRAMEWORKS/"
          ls -la "$FRAMEWORKS/QtDBus.framework/Versions/A/" || echo "QtDBus copy failed!"

          # Copy libdbus (dependency of QtDBus)
          echo "=== Copying libdbus ==="
          DBUS_LIB="$(brew --prefix dbus)/lib"
          cp "$DBUS_LIB/libdbus-1.3.dylib" "$FRAMEWORKS/"
          ln -sf libdbus-1.3.dylib "$FRAMEWORKS/libdbus-1.dylib"

          # Copy brotli libraries (dependency of QtNetwork)
          echo "=== Copying brotli libraries ==="
          BROTLI_LIB="$(brew --prefix brotli)/lib"
          cp "$BROTLI_LIB/libbrotlicommon.1.dylib" "$FRAMEWORKS/"
          cp "$BROTLI_LIB/libbrotlidec.1.dylib" "$FRAMEWORKS/"
          cp "$BROTLI_LIB/libbrotlienc.1.dylib" "$FRAMEWORKS/"
          ln -sf libbrotlicommon.1.dylib "$FRAMEWORKS/libbrotlicommon.dylib"
          ln -sf libbrotlidec.1.dylib "$FRAMEWORKS/libbrotlidec.dylib"
          ln -sf libbrotlienc.1.dylib "$FRAMEWORKS/libbrotlienc.dylib"

          # Get OpenSSL paths (resolve symlinks for install_name_tool)
          OPENSSL_LIB="$(brew --prefix openssl@3)/lib"
          OPENSSL_REAL="$(realpath $OPENSSL_LIB)"

          # Copy OpenSSL libraries
          echo "=== Copying OpenSSL libraries ==="
          cp "$OPENSSL_LIB/libssl.3.dylib" "$FRAMEWORKS/"
          cp "$OPENSSL_LIB/libcrypto.3.dylib" "$FRAMEWORKS/"

          # Copy Opus library
          echo "=== Copying Opus library ==="
          OPUS_LIB="$(brew --prefix opus)/lib"
          cp "$OPUS_LIB/libopus.0.dylib" "$FRAMEWORKS/"
          ln -sf libopus.0.dylib "$FRAMEWORKS/libopus.dylib"

          # Copy HIDAPI library
          echo "=== Copying HIDAPI library ==="
          HIDAPI_LIB="$(brew --prefix hidapi)/lib"
          cp "$HIDAPI_LIB/libhidapi.0.dylib" "$FRAMEWORKS/"
          ln -sf libhidapi.0.dylib "$FRAMEWORKS/libhidapi.dylib"

          # Fix permissions (Homebrew files may be read-only)
          chmod -R u+rw "$FRAMEWORKS/"

          # Fix OpenSSL library paths
          echo "=== Fixing library paths ==="
          install_name_tool -id "@executable_path/../Frameworks/libssl.3.dylib" \
            "$FRAMEWORKS/libssl.3.dylib"
          install_name_tool -id "@executable_path/../Frameworks/libcrypto.3.dylib" \
            "$FRAMEWORKS/libcrypto.3.dylib"
          install_name_tool -change "$OPENSSL_REAL/libcrypto.3.dylib" \
            "@executable_path/../Frameworks/libcrypto.3.dylib" \
            "$FRAMEWORKS/libssl.3.dylib"

          # Fix Opus library path
          install_name_tool -id "@executable_path/../Frameworks/libopus.0.dylib" \
            "$FRAMEWORKS/libopus.0.dylib" || true

          # Fix HIDAPI library path
          install_name_tool -id "@executable_path/../Frameworks/libhidapi.0.dylib" \
            "$FRAMEWORKS/libhidapi.0.dylib" || true

          # Fix libdbus library path
          echo "=== Fixing libdbus paths ==="
          install_name_tool -id "@executable_path/../Frameworks/libdbus-1.3.dylib" \
            "$FRAMEWORKS/libdbus-1.3.dylib" || true

          # Fix brotli library paths
          echo "=== Fixing brotli paths ==="
          install_name_tool -id "@executable_path/../Frameworks/libbrotlicommon.1.dylib" \
            "$FRAMEWORKS/libbrotlicommon.1.dylib" || true
          install_name_tool -id "@executable_path/../Frameworks/libbrotlidec.1.dylib" \
            "$FRAMEWORKS/libbrotlidec.1.dylib" || true
          install_name_tool -id "@executable_path/../Frameworks/libbrotlienc.1.dylib" \
            "$FRAMEWORKS/libbrotlienc.1.dylib" || true

          # Fix brotlidec's reference to brotlicommon
          BROTLI_COMMON_ORIG=$(otool -L "$FRAMEWORKS/libbrotlidec.1.dylib" | grep brotlicommon | awk '{print $1}')
          if [ -n "$BROTLI_COMMON_ORIG" ]; then
            install_name_tool -change "$BROTLI_COMMON_ORIG" \
              "@executable_path/../Frameworks/libbrotlicommon.1.dylib" \
              "$FRAMEWORKS/libbrotlidec.1.dylib"
          fi

          # Fix brotlienc's reference to brotlicommon
          BROTLI_COMMON_ORIG=$(otool -L "$FRAMEWORKS/libbrotlienc.1.dylib" | grep brotlicommon | awk '{print $1}')
          if [ -n "$BROTLI_COMMON_ORIG" ]; then
            install_name_tool -change "$BROTLI_COMMON_ORIG" \
              "@executable_path/../Frameworks/libbrotlicommon.1.dylib" \
              "$FRAMEWORKS/libbrotlienc.1.dylib"
          fi

          # Fix QtDBus.framework paths
          echo "=== Fixing QtDBus.framework paths ==="
          QTDBUS_BINARY="$FRAMEWORKS/QtDBus.framework/Versions/A/QtDBus"
          if [ -f "$QTDBUS_BINARY" ]; then
            install_name_tool -id "@executable_path/../Frameworks/QtDBus.framework/Versions/A/QtDBus" \
              "$QTDBUS_BINARY"

            # Update QtDBus's reference to libdbus
            DBUS_ORIG=$(otool -L "$QTDBUS_BINARY" | grep libdbus | awk '{print $1}')
            if [ -n "$DBUS_ORIG" ]; then
              echo "Updating QtDBus libdbus reference from: $DBUS_ORIG"
              install_name_tool -change "$DBUS_ORIG" \
                "@executable_path/../Frameworks/libdbus-1.3.dylib" \
                "$QTDBUS_BINARY"
            fi

            # Update QtGui's reference to QtDBus
            QTGUI_BINARY="$FRAMEWORKS/QtGui.framework/Versions/A/QtGui"
            if [ -f "$QTGUI_BINARY" ]; then
              # Get the original QtDBus path from QtGui
              QTDBUS_ORIG=$(otool -L "$QTGUI_BINARY" | grep QtDBus | awk '{print $1}')
              if [ -n "$QTDBUS_ORIG" ]; then
                echo "Updating QtGui reference from: $QTDBUS_ORIG"
                install_name_tool -change "$QTDBUS_ORIG" \
                  "@executable_path/../Frameworks/QtDBus.framework/Versions/A/QtDBus" \
                  "$QTGUI_BINARY"
              fi
            fi
          else
            echo "ERROR: QtDBus binary not found at $QTDBUS_BINARY"
            exit 1
          fi

          echo "=== Frameworks contents ==="
          ls -la "$FRAMEWORKS/" | head -30

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Set keychain for codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Verify certificate is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Sign Application
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Sign all frameworks and dylibs first, then the app
          APP_BUNDLE="build/K4Controller.app"

          echo "=== Signing frameworks and libraries ==="
          find "$APP_BUNDLE/Contents/Frameworks" -name "*.dylib" -exec \
            codesign --force --options runtime --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" {} \;

          find "$APP_BUNDLE/Contents/Frameworks" -name "*.framework" -exec \
            codesign --force --options runtime --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" {} \;

          echo "=== Signing PlugIns ==="
          find "$APP_BUNDLE/Contents/PlugIns" -name "*.dylib" -exec \
            codesign --force --options runtime --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" {} \;

          echo "=== Signing main application with entitlements ==="
          codesign --force --options runtime \
            --entitlements "resources/K4Controller.entitlements" \
            --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" \
            "$APP_BUNDLE"

          echo "=== Verifying signature ==="
          codesign --verify --verbose=2 "$APP_BUNDLE"

          # Check Gatekeeper acceptance
          spctl --assess --type execute --verbose "$APP_BUNDLE" || echo "Note: spctl may fail without notarization"

      - name: Create and Notarize DMG
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_KEY_BASE64: ${{ secrets.APPLE_API_KEY_BASE64 }}
        run: |
          APP_BUNDLE="build/K4Controller.app"

          # Create DMG staging directory with app and Applications symlink
          echo "=== Creating DMG staging directory ==="
          mkdir -p dmg-staging
          # Use ditto for proper macOS bundle handling
          ditto "$APP_BUNDLE" dmg-staging/K4Controller.app
          ln -s /Applications dmg-staging/Applications

          # Ensure filesystem is synced and Spotlight doesn't interfere
          sync
          touch dmg-staging/.metadata_never_index
          sleep 2

          # Create the DMG
          echo "=== Creating DMG ==="
          hdiutil create -volname "K4Controller" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            -nocrossdev \
            "K4Controller-unsigned.dmg"

          # Sign the DMG
          echo "=== Signing DMG ==="
          codesign --force --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" \
            "K4Controller-unsigned.dmg"
          mv "K4Controller-unsigned.dmg" "K4Controller-macos.dmg"

          # Create API key file for notarization
          mkdir -p ~/private_keys
          echo "$APPLE_API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_$APPLE_API_KEY_ID.p8

          # Notarize the DMG
          echo "=== Submitting DMG for notarization ==="
          xcrun notarytool submit "K4Controller-macos.dmg" \
            --key ~/private_keys/AuthKey_$APPLE_API_KEY_ID.p8 \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --wait \
            --timeout 30m

          # Staple the notarization ticket to the DMG
          echo "=== Stapling notarization ticket to DMG ==="
          xcrun stapler staple "K4Controller-macos.dmg"

          # Verify
          echo "=== Verifying DMG ==="
          xcrun stapler validate "K4Controller-macos.dmg"
          spctl --assess --type open --context context:primary-signature "K4Controller-macos.dmg" || echo "spctl check completed"

          # Show package info
          echo "=== Release DMG created ==="
          ls -lh K4Controller-macos.dmg

          # Clean up
          rm -rf dmg-staging ~/private_keys

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: K4Controller-macos
          path: K4Controller-macos.dmg

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          # Tag format: v0.1.0 or v0.1.0-alpha.123
          # Strip leading 'v' to get version string
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
          key: vcpkg-win-${{ hashFiles('.github/workflows/release.yml') }}
          restore-keys: |
            vcpkg-win-

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtmultimedia qtshadertools qtserialport'
          cache: true

      - name: Setup vcpkg
        run: |
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat

      - name: Install dependencies
        run: vcpkg install opus:x64-windows hidapi:x64-windows openssl:x64-windows

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure CMake
        run: cmake -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache -DK4CONTROLLER_VERSION_FULL="${{ steps.version.outputs.version }}"

      - name: Build
        run: cmake --build build

      - name: Create release package
        run: |
          mkdir K4Controller-windows
          copy build\K4Controller.exe K4Controller-windows\

          # Use windeployqt to bundle Qt DLLs
          windeployqt --release --no-translations K4Controller-windows\K4Controller.exe

          # Copy vcpkg DLLs (opus, hidapi, openssl)
          copy C:\vcpkg\installed\x64-windows\bin\opus.dll K4Controller-windows\
          copy C:\vcpkg\installed\x64-windows\bin\hidapi.dll K4Controller-windows\
          copy C:\vcpkg\installed\x64-windows\bin\libssl-3-x64.dll K4Controller-windows\
          copy C:\vcpkg\installed\x64-windows\bin\libcrypto-3-x64.dll K4Controller-windows\

          Compress-Archive -Path K4Controller-windows -DestinationPath K4Controller-windows.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: K4Controller-windows
          path: K4Controller-windows.zip

  build-raspberry-pi:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Cache Pi build dependencies
        uses: actions/cache@v4
        with:
          path: |
            /tmp/pi-apt-cache
            /tmp/pi-ccache
          key: pi-arm64-${{ hashFiles('.github/scripts/build-pi.sh') }}
          restore-keys: pi-arm64-

      - name: Cross-compile for ARM64 in Debian Trixie
        run: |
          mkdir -p /tmp/pi-apt-cache /tmp/pi-ccache
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v /tmp/pi-apt-cache:/var/cache/apt/archives \
            -v /tmp/pi-ccache:/ccache \
            -e CCACHE_DIR=/ccache \
            -w /workspace \
            debian:trixie \
            bash /workspace/.github/scripts/build-pi.sh "${{ steps.version.outputs.version }}"
          # Fix ownership so actions/cache can tar the files (Docker writes as root)
          sudo chown -R $(id -u):$(id -g) /tmp/pi-apt-cache /tmp/pi-ccache

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: K4Controller-raspberry-pi
          path: K4Controller-raspberry-pi-arm64.tar.gz

  release:
    needs: [build-macos, build-windows, build-raspberry-pi]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: K4Controller-macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: K4Controller-windows

      - name: Download Raspberry Pi artifact
        uses: actions/download-artifact@v4
        with:
          name: K4Controller-raspberry-pi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            K4Controller-macos.dmg
            K4Controller-windows.zip
            K4Controller-raspberry-pi-arm64.tar.gz
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}

  publish:
    needs: [release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: K4Controller-macos
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: K4Controller-windows
          path: artifacts/windows

      - name: Download Raspberry Pi artifact
        uses: actions/download-artifact@v4
        with:
          name: K4Controller-raspberry-pi
          path: artifacts/raspberry-pi

      - name: Update downloads and releases.json
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          DATE=$(date -u +%Y-%m-%d)

          # Remove old downloads, add new
          rm -rf downloads/
          mkdir -p "downloads/$TAG"
          cp artifacts/macos/K4Controller-macos.dmg "downloads/$TAG/"
          cp artifacts/windows/K4Controller-windows.zip "downloads/$TAG/"
          cp artifacts/raspberry-pi/K4Controller-raspberry-pi-arm64.tar.gz "downloads/$TAG/"

          # Compute human-readable sizes
          SZ_MAC=$(du -h "downloads/$TAG/K4Controller-macos.dmg" | cut -f1 | xargs)
          SZ_WIN=$(du -h "downloads/$TAG/K4Controller-windows.zip" | cut -f1 | xargs)
          SZ_PI=$(du -h "downloads/$TAG/K4Controller-raspberry-pi-arm64.tar.gz" | cut -f1 | xargs)

          # Detect prerelease
          if echo "$TAG" | grep -qE 'alpha|beta'; then
            PRERELEASE=true
          else
            PRERELEASE=false
          fi

          # Build releases.json
          cat > releases.json <<EOF
          {
            "tag": "$TAG",
            "version": "$VERSION",
            "date": "$DATE",
            "prerelease": $PRERELEASE,
            "assets": {
              "macos": {
                "name": "K4Controller-macos.dmg",
                "url": "./downloads/$TAG/K4Controller-macos.dmg",
                "size": "$SZ_MAC"
              },
              "windows": {
                "name": "K4Controller-windows.zip",
                "url": "./downloads/$TAG/K4Controller-windows.zip",
                "size": "$SZ_WIN"
              },
              "raspberry-pi": {
                "name": "K4Controller-raspberry-pi-arm64.tar.gz",
                "url": "./downloads/$TAG/K4Controller-raspberry-pi-arm64.tar.gz",
                "size": "$SZ_PI"
              }
            }
          }
          EOF

          # Clean up artifacts directory
          rm -rf artifacts/

      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Release ${{ github.ref_name }}"
          git push
