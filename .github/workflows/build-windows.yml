name: Build Windows

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]

    # Self-hosted runner pre-installed tools:
    #   Qt 6.10.1 (MinGW), MinGW 13.1, Opus, HIDAPI, OpenSSL 3.x, NSIS
    env:
      QT_ROOT_DIR: C:/Qt/6.10.1/mingw_64
      MINGW_BIN: C:/Qt/Tools/mingw1310_64/bin
      OPUS_ROOT: C:/opus
      HIDAPI_ROOT: C:/hidapi
      OPENSSL_DIR: C:/Program Files/OpenSSL-Win64

    steps:
      - uses: actions/checkout@v4
        with:
          clean: false
          fetch-depth: 2

      - name: Smart clean
        shell: bash
        run: |
          if git diff HEAD~1 --name-only 2>/dev/null | grep -qE '(CMakeLists\.txt|\.cmake)'; then
            echo "Build system changed - forcing clean rebuild"
            rm -rf build || true
          fi

      - name: Configure CMake
        shell: bash
        run: |
          export PATH="${{ env.MINGW_BIN }}:$PATH"
          cmake -B build -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${{ env.QT_ROOT_DIR }}" \
            -DOPUS_ROOT="${{ env.OPUS_ROOT }}" \
            -DHIDAPI_ROOT="${{ env.HIDAPI_ROOT }}"

      - name: Build
        shell: bash
        run: |
          export PATH="${{ env.MINGW_BIN }}:$PATH"
          cmake --build build -j4

      - name: Verify executable
        shell: bash
        run: |
          if [ -f build/QK4.exe ]; then
            echo "Build successful"
            ls -lh build/QK4.exe
          else
            echo "Build failed - executable not found"
            exit 1
          fi

      - name: Create release package
        shell: bash
        run: |
          rm -rf QK4-windows
          mkdir -p QK4-windows
          cp build/QK4.exe QK4-windows/

          # Use windeployqt to bundle Qt DLLs and plugins
          "${{ env.QT_ROOT_DIR }}/bin/windeployqt.exe" --release --no-translations QK4-windows/QK4.exe

          # Copy HIDAPI DLL
          cp "${{ env.HIDAPI_ROOT }}/bin/libhidapi.dll" QK4-windows/

          # Copy MinGW runtime DLLs
          cp "${{ env.MINGW_BIN }}/libgcc_s_seh-1.dll" QK4-windows/
          cp "${{ env.MINGW_BIN }}/libstdc++-6.dll" QK4-windows/
          cp "${{ env.MINGW_BIN }}/libwinpthread-1.dll" QK4-windows/

          # Copy OpenSSL runtime DLLs (required by Qt TLS/PSK backend)
          if [ -f "${{ env.OPENSSL_DIR }}/bin/libssl-3-x64.dll" ]; then
            cp "${{ env.OPENSSL_DIR }}/bin/libssl-3-x64.dll" QK4-windows/
            cp "${{ env.OPENSSL_DIR }}/bin/libcrypto-3-x64.dll" QK4-windows/
          fi

          echo "=== Release package contents ==="
          ls -la QK4-windows/

      - name: Build installer
        shell: bash
        run: |
          cd installer
          "/c/Program Files (x86)/NSIS/makensis.exe" /DAPPVERSION=0.0.0-test qk4.nsi
          cd ..
          echo "=== Installer created ==="
          ls -lh QK4-0.0.0-test-Setup.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: QK4-windows
          path: |
            QK4-windows/
            QK4-*-Setup.exe
          retention-days: 7
