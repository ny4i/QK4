name: Build Windows

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: [self-hosted, Windows, X64]

    # Self-hosted runner pre-installed tools:
    #   Qt 6.10.1 (MinGW), MinGW 13.1, Opus, HIDAPI, OpenSSL 3.x, NSIS
    env:
      QT_ROOT_DIR: C:/Qt/6.10.1/mingw_64
      MINGW_BIN: C:/Qt/Tools/mingw1310_64/bin
      OPUS_ROOT: C:/opus
      HIDAPI_ROOT: C:/hidapi

    steps:
      - uses: actions/checkout@v4
        with:
          clean: false
          fetch-depth: 2

      - name: Smart clean
        shell: bash
        run: |
          if git diff HEAD~1 --name-only 2>/dev/null | grep -qE '(CMakeLists\.txt|\.cmake)'; then
            echo "Build system changed - forcing clean rebuild"
            rm -rf build || true
          fi

      - name: Configure CMake
        shell: bash
        run: |
          export PATH="${{ env.MINGW_BIN }}:$PATH"
          cmake -B build -G "MinGW Makefiles" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${{ env.QT_ROOT_DIR }}" \
            -DOPUS_ROOT="${{ env.OPUS_ROOT }}" \
            -DHIDAPI_ROOT="${{ env.HIDAPI_ROOT }}"

      - name: Build
        shell: bash
        run: |
          export PATH="${{ env.MINGW_BIN }}:$PATH"
          cmake --build build -j4

      - name: Verify executable
        shell: bash
        run: |
          if [ -f build/QK4.exe ]; then
            echo "Build successful"
            ls -lh build/QK4.exe
          else
            echo "Build failed - executable not found"
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: QK4-windows
          path: build/QK4.exe
          retention-days: 7
