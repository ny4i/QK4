name: Build macOS

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Cache Homebrew downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew/downloads
            ~/Library/Caches/Homebrew/api
          key: brew-macos-${{ hashFiles('.github/workflows/build-macos.yml') }}
          restore-keys: brew-macos-

      - name: Install dependencies
        run: brew install qt opus openssl@3 hidapi dbus brotli

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt)" \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build
        run: cmake --build build --config Release

      - name: Verify executable
        run: test -f build/QK4.app/Contents/MacOS/QK4

      - name: Bundle dependencies
        run: |
          set -e

          APP_BUNDLE="build/QK4.app"
          FRAMEWORKS="$APP_BUNDLE/Contents/Frameworks"

          # Run macdeployqt to bundle Qt frameworks
          $(brew --prefix qt)/bin/macdeployqt "$APP_BUNDLE" -verbose=2

          # Copy QtDBus.framework (transitive dependency of QtGui in Homebrew Qt)
          echo "=== Copying QtDBus.framework ==="
          QTBASE_LIB="$(brew --prefix qtbase)/lib"
          cp -R "$QTBASE_LIB/QtDBus.framework" "$FRAMEWORKS/"

          # Copy libdbus (dependency of QtDBus)
          echo "=== Copying libdbus ==="
          DBUS_LIB="$(brew --prefix dbus)/lib"
          cp "$DBUS_LIB/libdbus-1.3.dylib" "$FRAMEWORKS/"
          ln -sf libdbus-1.3.dylib "$FRAMEWORKS/libdbus-1.dylib"

          # Copy brotli libraries (dependency of QtNetwork)
          echo "=== Copying brotli libraries ==="
          BROTLI_LIB="$(brew --prefix brotli)/lib"
          cp "$BROTLI_LIB/libbrotlicommon.1.dylib" "$FRAMEWORKS/"
          cp "$BROTLI_LIB/libbrotlidec.1.dylib" "$FRAMEWORKS/"
          cp "$BROTLI_LIB/libbrotlienc.1.dylib" "$FRAMEWORKS/"
          ln -sf libbrotlicommon.1.dylib "$FRAMEWORKS/libbrotlicommon.dylib"
          ln -sf libbrotlidec.1.dylib "$FRAMEWORKS/libbrotlidec.dylib"
          ln -sf libbrotlienc.1.dylib "$FRAMEWORKS/libbrotlienc.dylib"

          # Get OpenSSL paths (resolve symlinks for install_name_tool)
          OPENSSL_LIB="$(brew --prefix openssl@3)/lib"
          OPENSSL_REAL="$(realpath $OPENSSL_LIB)"

          # Copy OpenSSL libraries
          echo "=== Copying OpenSSL libraries ==="
          cp "$OPENSSL_LIB/libssl.3.dylib" "$FRAMEWORKS/"
          cp "$OPENSSL_LIB/libcrypto.3.dylib" "$FRAMEWORKS/"

          # Copy Opus library
          echo "=== Copying Opus library ==="
          OPUS_LIB="$(brew --prefix opus)/lib"
          cp "$OPUS_LIB/libopus.0.dylib" "$FRAMEWORKS/"
          ln -sf libopus.0.dylib "$FRAMEWORKS/libopus.dylib"

          # Copy HIDAPI library
          echo "=== Copying HIDAPI library ==="
          HIDAPI_LIB="$(brew --prefix hidapi)/lib"
          cp "$HIDAPI_LIB/libhidapi.0.dylib" "$FRAMEWORKS/"
          ln -sf libhidapi.0.dylib "$FRAMEWORKS/libhidapi.dylib"

          # Fix permissions (Homebrew files may be read-only)
          chmod -R u+rw "$FRAMEWORKS/"

          # Fix OpenSSL library paths
          echo "=== Fixing library paths ==="
          install_name_tool -id "@executable_path/../Frameworks/libssl.3.dylib" \
            "$FRAMEWORKS/libssl.3.dylib"
          install_name_tool -id "@executable_path/../Frameworks/libcrypto.3.dylib" \
            "$FRAMEWORKS/libcrypto.3.dylib"
          install_name_tool -change "$OPENSSL_REAL/libcrypto.3.dylib" \
            "@executable_path/../Frameworks/libcrypto.3.dylib" \
            "$FRAMEWORKS/libssl.3.dylib"

          # Fix Opus library path
          install_name_tool -id "@executable_path/../Frameworks/libopus.0.dylib" \
            "$FRAMEWORKS/libopus.0.dylib" || true

          # Fix HIDAPI library path
          install_name_tool -id "@executable_path/../Frameworks/libhidapi.0.dylib" \
            "$FRAMEWORKS/libhidapi.0.dylib" || true

          # Fix libdbus library path
          echo "=== Fixing libdbus paths ==="
          install_name_tool -id "@executable_path/../Frameworks/libdbus-1.3.dylib" \
            "$FRAMEWORKS/libdbus-1.3.dylib" || true

          # Fix brotli library paths
          echo "=== Fixing brotli paths ==="
          install_name_tool -id "@executable_path/../Frameworks/libbrotlicommon.1.dylib" \
            "$FRAMEWORKS/libbrotlicommon.1.dylib" || true
          install_name_tool -id "@executable_path/../Frameworks/libbrotlidec.1.dylib" \
            "$FRAMEWORKS/libbrotlidec.1.dylib" || true
          install_name_tool -id "@executable_path/../Frameworks/libbrotlienc.1.dylib" \
            "$FRAMEWORKS/libbrotlienc.1.dylib" || true

          # Fix brotlidec's reference to brotlicommon
          BROTLI_COMMON_ORIG=$(otool -L "$FRAMEWORKS/libbrotlidec.1.dylib" | grep brotlicommon | awk '{print $1}')
          if [ -n "$BROTLI_COMMON_ORIG" ]; then
            install_name_tool -change "$BROTLI_COMMON_ORIG" \
              "@executable_path/../Frameworks/libbrotlicommon.1.dylib" \
              "$FRAMEWORKS/libbrotlidec.1.dylib"
          fi

          # Fix brotlienc's reference to brotlicommon
          BROTLI_COMMON_ORIG=$(otool -L "$FRAMEWORKS/libbrotlienc.1.dylib" | grep brotlicommon | awk '{print $1}')
          if [ -n "$BROTLI_COMMON_ORIG" ]; then
            install_name_tool -change "$BROTLI_COMMON_ORIG" \
              "@executable_path/../Frameworks/libbrotlicommon.1.dylib" \
              "$FRAMEWORKS/libbrotlienc.1.dylib"
          fi

          # Fix QtDBus.framework paths
          echo "=== Fixing QtDBus.framework paths ==="
          QTDBUS_BINARY="$FRAMEWORKS/QtDBus.framework/Versions/A/QtDBus"
          if [ -f "$QTDBUS_BINARY" ]; then
            install_name_tool -id "@executable_path/../Frameworks/QtDBus.framework/Versions/A/QtDBus" \
              "$QTDBUS_BINARY"

            # Update QtDBus's reference to libdbus
            DBUS_ORIG=$(otool -L "$QTDBUS_BINARY" | grep libdbus | awk '{print $1}')
            if [ -n "$DBUS_ORIG" ]; then
              install_name_tool -change "$DBUS_ORIG" \
                "@executable_path/../Frameworks/libdbus-1.3.dylib" \
                "$QTDBUS_BINARY"
            fi

            # Update QtGui's reference to QtDBus
            QTGUI_BINARY="$FRAMEWORKS/QtGui.framework/Versions/A/QtGui"
            if [ -f "$QTGUI_BINARY" ]; then
              QTDBUS_ORIG=$(otool -L "$QTGUI_BINARY" | grep QtDBus | awk '{print $1}')
              if [ -n "$QTDBUS_ORIG" ]; then
                install_name_tool -change "$QTDBUS_ORIG" \
                  "@executable_path/../Frameworks/QtDBus.framework/Versions/A/QtDBus" \
                  "$QTGUI_BINARY"
              fi
            fi
          else
            echo "ERROR: QtDBus binary not found at $QTDBUS_BINARY"
            exit 1
          fi

          echo "=== Frameworks contents ==="
          ls -la "$FRAMEWORKS/" | head -30

      - name: Import Code Signing Certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Set keychain for codesign
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Verify certificate is available
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Sign Application
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_BUNDLE="build/QK4.app"

          echo "=== Signing frameworks and libraries ==="
          find "$APP_BUNDLE/Contents/Frameworks" -name "*.dylib" -exec \
            codesign --force --options runtime --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" {} \;

          find "$APP_BUNDLE/Contents/Frameworks" -name "*.framework" -exec \
            codesign --force --options runtime --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" {} \;

          echo "=== Signing PlugIns ==="
          find "$APP_BUNDLE/Contents/PlugIns" -name "*.dylib" -exec \
            codesign --force --options runtime --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" {} \;

          echo "=== Signing main application with entitlements ==="
          codesign --force --options runtime \
            --entitlements "resources/QK4.entitlements" \
            --sign "Developer ID Application: Michael Richard Garcia ($APPLE_TEAM_ID)" \
            "$APP_BUNDLE"

          echo "=== Verifying signature ==="
          codesign --verify --verbose=2 "$APP_BUNDLE"

      - name: Package artifact
        run: cd build && zip -r ../QK4-macos.zip QK4.app

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: QK4-macos
          path: QK4-macos.zip
          retention-days: 7
